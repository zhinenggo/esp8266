

- 官方SDK开发文档：https://code.aliyun.com/edward.yangx/public-docs/wikis/user-guide/linkkit/Prog_Guide/API/Linkkit_Provides
- 阿里云物模型上报：https://help.aliyun.com/document_detail/96628.html?spm=a2c4g.11186623.6.587.787b442dKH6dNo


## 一、为何需要主动上报数据到天猫精灵

- 当这样的情景出现。你关闭了灯，但是并没有上报到天猫精灵，因此对天猫精灵说查询设备：他会说灯依然处于打开状态，非常尴尬！
- 细心的同学会发现在 solo.c 文件实例发现这样的情况：当你关闭了灯，再一次语音设置了绿色或者其他颜色，这时候问天猫精灵灯处于什么状态，但是依然会说 灯处于关闭状态；


## 二、按键设置灯的颜色
-  为了更好地演示这个效果，我们采用按键来改变灯的颜色状态并且上报给天猫精灵；
-  添加 《button》 组件进去，根据原理图可得：GPIO0 GPIO5 GPIO4 为按键；

- 注意我们要当连接成功服务器，才可以上报数据，这里我定义一个变量 linkkit_connected  表示是否与服务器连接！


```


static bool linkkit_connected = false;

//短按函数
static void ButtonShortPressCallBack(void *arg)
{

    char property_payload[50] = {0};

    if (strcmp((char *)arg, "Button0") == 0)
    {
        ESP_LOGI(TAG, "button0");
        ws2812_setColor(254, 0, 0);

        if (linkkit_connected)
        {

            HAL_Snprintf(property_payload, sizeof(property_payload), "{\"color\":16711680,\"powerstate\":1}");
        }
    }
    else if (strcmp((char *)arg, "Button1") == 0)
    {
        ESP_LOGI(TAG, "button1");
        ws2812_setColor(0, 254, 0);
        if (linkkit_connected)
        {
            HAL_Snprintf(property_payload, sizeof(property_payload), "{\"color\":65280,\"powerstate\":1}");
        }
    }
    else if (strcmp((char *)arg, "Button2") == 0)
    {
        ESP_LOGI(TAG, "button2");
        ws2812_setColor(0, 0, 254);
        if (linkkit_connected)
        {

            HAL_Snprintf(property_payload, sizeof(property_payload), "{\"color\":255,\"powerstate\":1}");
        }
    }
    IOT_Linkkit_Report(0, ITM_MSG_POST_PROPERTY, (unsigned char *)property_payload, strlen(property_payload));
    //ESP_LOGI(TAG, "ButtonShortPressCallBack type %s %d esp_get_free_heap_size(): %d ", type, strlen(type), esp_get_free_heap_size());
}



/**
 * @description: 按键驱动
 * @param {type} 
 * @return: 
 */
void TaskButton()
{
    //定义一个 gpio 下降沿触发
    button_handle_t btn_handle = button_dev_init(0, 0, BUTTON_ACTIVE_LOW);
    button_dev_add_tap_cb(BUTTON_PUSH_CB, ButtonShortPressCallBack, "Button0", 50 / portTICK_PERIOD_MS, btn_handle);
    //定义一个 gpio 下降沿触发
    btn_handle = button_dev_init(4, 0, BUTTON_ACTIVE_LOW);
    button_dev_add_tap_cb(BUTTON_PUSH_CB, ButtonShortPressCallBack, "Button1", 50 / portTICK_PERIOD_MS, btn_handle); //定义一个 gpio 下降沿触发
    btn_handle = button_dev_init(5, 0, BUTTON_ACTIVE_LOW);
    button_dev_add_tap_cb(BUTTON_PUSH_CB, ButtonShortPressCallBack, "Button2", 50 / portTICK_PERIOD_MS, btn_handle);
    vTaskDelete(NULL);
}

```






## 三、解决下发设置颜色控制依然提示关灯的bug

- 因为下发时候的关灯指令更新了 开关的 关状态，而颜色控制依然没主动更新开关的 状态，导致查询会提示关灯！
- 所以，在设置颜色时候，还要主动 上报一个 灯开的指令！


```
//定义上报的数据
const char lightOpenData[] = {"{\"powerstate\":1}"};
//在设置颜色时候，主动上报
res = IOT_Linkkit_Report(EXAMPLE_MASTER_DEVID, ITM_MSG_POST_PROPERTY, (unsigned char *)lightOpenData, strlen(lightOpenData));
```

## 四、属性上报说明

- 用户可以调用IOT_Linkkit_Report()函数来上报属性，属性上报时需要按照云端定义的属性格式使用JSON编码后进行上报。示例中函数user_post_property展示了如何使用IOT_Linkkit_Report进行属性上报（对于异常情况的上报，详见example）:



```
void user_post_property(void)
{
    static int cnt = 0;
    int res = 0;
    char property_payload[30] = {0};
    HAL_Snprintf(property_payload, sizeof(property_payload), "{\"Counter\": %d}", cnt++);
    res = IOT_Linkkit_Report(EXAMPLE_MASTER_DEVID, ITM_MSG_POST_PROPERTY,
                            (unsigned char *)property_payload, strlen(property_payload));
    EXAMPLE_TRACE("Post Property Message ID: %d", res);
}
```




## 五、关于上报消息的格式说明及示例
上报属性时, 属性ID和值以JSON格式的形式放在IOT_Linkkit_Report()的payload中, 不同数据类型以及多个属性的格式示例如下:



```
/* 整型数据 */
char *payload = "{\"Brightness\":50}";
/* 浮点型数据上报 */
char *payload = "{\"Temperature\":11.11}";
/* 枚举型数据上报 */
char *payload = "{\"WorkMode\":2}";
/* 布尔型数据上报, 在物模型定义中, 布尔型为整型, 取值为0或1, 与JSON格式的整型不同 */
char *payload = "{\"LightSwitch\":1}";
/* 字符串数据上报 */
char *payload = "{\"Description\":\"Amazing Example\"}";
/* 时间型数据上报, 在物模型定义中, 时间型为字符串 */
char *payload = "{\"Timestamp\":\"1252512000\"}";
/* 复合类型属性上报, 在物模型定义中, 符合类型属性为JSON对象 */
char *payload = "{\"RGBColor:{\"Red\":11,\"Green\":22,\"Blue\":33}\"}";
/* 多属性上报, 如果需要上报以上各种数据类型的所有属性, 将它们放在一个JSON对象中即可 */
char *payload = "{\"Brightness\":50,\"Temperature\":11.11,\"WorkMode\":2,\"LightSwitch\":1,\"Description\":\"Amazing Example\",\"Timestamp\":\"1252512000\",\"RGBColor:{\"Red\":11,\"Green\":22,\"Blue\":33}\"}";
/* 属性payload准备好以后, 就可以使用如下接口进行上报了 */
IOT_Linkkit_Report(devid, ITM_MSG_POST_PROPERTY, payload, strlen(payload));
```
## 六、解决下发颜色控制时候，要上报开灯状态；

- 为什么会出现同步失败？
- 下发颜色控制时候，上报并没 开灯属性设置为true 并上报给天猫精灵！
- 解决方法：下发颜色控制时候，要上报开灯状态为true


```
 const char lightOpenData[] = {"{\"powerstate\":1}"};
 res = IOT_Linkkit_Report(EXAMPLE_MASTER_DEVID, ITM_MSG_POST_PROPERTY, (unsigned char *)lightOpenData, strlen(lightOpenData));
```
