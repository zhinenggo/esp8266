[TOC]

## 控制前准备 

**请一定要在 天猫精灵APP 找到这个设备设置下别名，后面就可以根据这个别名 来控制设备啦！**

## 一、修改下发的数据处理

在 ```linkki_solo.c```文件的 ```user_property_set_event_handler ```方法修改，一定要看准协议来解析，因为后面还有智能插座或者其他产品的协议有所不同的！

不管怎么变，我们需要掌握 json 的解析就好了！而仓库是内置 cJSON解析库的大家用这个就好了！

## 二、添加 8266 驱动 ws2812 的驱动文件进去；

从我的GitHub拉取 8266代码，拿到 8266 3.0驱动ws2812的例子，复制文件夹 ws2812 到工程里面去即可添加；

## 三、天猫精灵颜色控制的枚举类型；


|指令含义|payload|
|----|----|
|开灯：|{"powerstate":0}|
|关灯：|{"powerstate":1}|
|蓝色：|{"color":255}|
|绿色：|{"color":65280}|
|青色：|{"color":65535}|
|紫色：|{"color":8388736}|
|红色：|{"color":16711680}|
|橙色：|{"color":16753820｝|
|黄色：|{"color":16776960}|

## 四、解析参考：



```c
static int user_property_set_event_handler(const int devid, const char *request, const int request_len)
 {
     int res = 0, value = 0;
     cJSON *root = NULL, *LightSwitch = NULL, *LightColor = NULL;
     ESP_LOGE(TAG, "Property Set Received, Devid: %d, Request: %s", devid, request);
     if (!request)
     {
         return NULL_VALUE_ERROR;
     }
    /* 整体判断是否为json */
    root = cJSON_Parse(request);
    if (!root)
    {
        ESP_LOGI(TAG, "JSON Parse Error");
        return FAIL_RETURN;
    }
    LightSwitch = cJSON_GetObjectItem(root, "powerstate");
    //是否为开关指令
    if (LightSwitch)
    {
        ESP_LOGE(TAG, "Property LightSwitch->valueint: %d", LightSwitch->valueint);
        if (LightSwitch->valueint == 1)
        {
            rgb_set_pwm(0, 100, 0);
        }
        else
        {
            rgb_set_pwm(0, 0, 0);
        }
    }
    LightColor = cJSON_GetObjectItem(root, "color");
    if (LightColor)
    {
        ESP_LOGE(TAG, "Property LightColor->valueint: %d", LightColor->valueint);
        value = LightColor->valueint;
        switch (value)
        {
        case 16711680: //红色
            rgb_set_pwm(100, 0, 0);
            break;
        case 255: //蓝色：
            rgb_set_pwm(0, 0, 100);
            break;
        case 65280: //绿色
            rgb_set_pwm(0, 100, 0);
            break;
        case 65535: //青色
            rgb_set_pwm(0, 100, 100);
            break;
        case 8388736: //紫色
            rgb_set_pwm(50, 0, 50);
            break;
        case 16753920: //橙色
            rgb_set_pwm(100, 50, 0);
            break;
        case 16776960: //黄色
            rgb_set_pwm(100, 100, 99);
            break;
        default:
            break;
        }
    }
    cJSON_Delete(root);
    res = IOT_Linkkit_Report(devid, ITM_MSG_POST_PROPERTY, (unsigned char *)request, request_len);
    return SUCCESS_RETURN;
}
```